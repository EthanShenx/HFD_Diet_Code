# —— 外圈基因端点
geom_point(data = edges,
aes(x = theta2, y = r_gene,
size = -log10(padj)),
colour = "tomato") +
# —— 内圈 GO term 端点
geom_point(data = pathways,
aes(x = theta, y = r_path),
shape = 21, fill = "white", colour = "black", size = 3) +
# —— 基因标签
geom_text_repel(data = edges %>% filter(-log10(padj) > 1),  # 只给显著的几个贴 label
aes(x = theta2, y = r_gene, label = gene),
nudge_y    = 0.2,
segment.size = 0.2,
size       = 2.5,
min.segment.length = 0) +
# —— GO term 标签
geom_text(data = pathways,
aes(x = theta, y = r_path - 0.1, label = pathway),
angle      = pathways$theta - 90,    # 文字围圈旋转
hjust      = 1,
size       = 3, fontface = "bold") +
# —— 坐标与样式
coord_polar(theta = "x", start = 0) +
scale_size_continuous(range = c(1, 5)) +   # 点大小映射
theme_void() +
theme(legend.position = "none")
# —— 加载包 ——
library(tidyverse)
library(ggrepel)
library(viridis)       # 色板
library(extrafont)     # 字体支持（事先用 font_import() 安装 Helvetica）
# —— 读取数据 ——
LumProg_Down_ORA_GO <- read_csv(
"/Users/coellearth/Desktop/Mammary_Gland_Diet_Project/3Enrichment/ORA_results/LumProg_Down_ORA_GO.csv"
)
# —— 筛选并展开 edges ——
selected_pathways <- c(
"response to peptide hormone",
"mammary gland development",
"negative regulation of ERBB signaling pathway"
)
edges <- LumProg_Down_ORA_GO %>%
filter(Description %in% selected_pathways) %>%
select(ID, Description, geneID, p.adjust) %>%
rename(pathway = Description, padj = p.adjust) %>%
mutate(gene = str_split(geneID, "/")) %>%
unnest(gene) %>%
select(pathway, gene, padj)
# —— 计算极坐标角度 ——
pathways <- edges %>%
distinct(pathway) %>%
arrange(pathway) %>%
mutate(theta = seq(10, 170, length.out = n()))
edges <- edges %>%
left_join(pathways, by = "pathway") %>%
arrange(pathway, gene) %>%
mutate(theta2 = seq(190, 350, length.out = n()))
# —— 半径设置 ——
r_path <- 1.0
r_gene <- 2.0
# —— 画图 ——
p <- ggplot() +
# 1. pathway–gene 连接线，按通路着色
geom_curve(
data = edges,
aes(
x    = theta2, y    = r_gene,
xend = theta,  yend = r_path,
color = pathway
),
curvature = 0.4,
size      = 0.4,
alpha     = 0.7
) +
# 2. gene 点，用 padj 映射大小
geom_point(
data = edges,
aes(x = theta2, y = r_gene, size = -log10(padj)),
color = "tomato"
) +
# 3. pathway 点
geom_point(
data = pathways,
aes(x = theta, y = r_path),
shape = 21, fill = "white", color = "black", size = 4
) +
# 4. gene 标签，只标 padj 映射 >1 的
geom_text_repel(
data = edges %>% filter(-log10(padj) > 1),
aes(x = theta2, y = r_gene, label = gene),
nudge_y         = 0.2,
segment.size    = 0.25,
size            = 3,
family          = "Helvetica",
min.segment.length = 0
) +
# 5. pathway 标签，绕圈旋转
geom_text(
data = pathways,
aes(x = theta, y = r_path - 0.1, label = pathway, angle = theta - 90),
hjust     = 1,
size      = 3.5,
family    = "Helvetica",
fontface  = "bold"
) +
# 6. 极坐标+配色+大小标度
coord_polar(theta = "x") +
scale_color_viridis_d(option = "D", begin = 0.2, end = 0.8, direction = -1) +
scale_size_continuous(range = c(1.5, 6)) +
# 7. 纯净背景 & 字体设置
theme_void(base_family = "Helvetica") +
theme(
legend.position = "none",
plot.margin = margin(10, 10, 10, 10)
)
# —— 保存高清图像，供 Nature 投稿 ——
ggsave(
filename = "Fig3_circular_Nature_ready.tiff",
plot     = p,
device   = "tiff",
width    = 180,   # 单位 mm
height   = 180,
dpi      = 600,
compression = "lzw"
)
p
install.packages("treemap")
install_github("gaospecial/ccgraph")
install_github("gaospecial/ccgraph")
library(devtools)
install_github("gaospecial/ccgraph")
library(tidyverse)
library(ggrepel)
library(tidygraph)
library(ggraph)
library(ccgraph)
library(treemap)
index <- c("Pathway","Gene")
View(p)
View(pathways)
View(p)
View(LumProg_ORA_GO)
View(LumProg_Down_ORA_GO)
selected_pathways <- c("response to peptide hormone",
"mammary gland development",
"negative regulation of ERBB signaling pathway")
to_plot <- LumProg_Down_ORA_GO %>%
filter(Description %in% selected_pathways) %>%
select(ID, Description, geneID, p.adjust) %>%
rename(pathway = Description, padj = p.adjust) %>%
mutate(gene = str_split(geneID, "/")) %>%
unnest(gene) %>%
select(pathway, gene, padj)
index <- c("pathway","gene")
nodes <- gather_graph_node(to_plot,index=index, root="root")
edges <- gather_graph_edge(to_plot,index=index, root="root")
View(nodes)
View(edges)
graph <- tbl_graph(nodes = nodes,edges = edges)
p1 <- ggraph(graph,layout = 'dendrogram', circular = TRUE) +
geom_edge_diagonal(aes(color=node1.node.branch),
alpha=0.5)
p1 <- ggraph(graph, layout = 'dendrogram', circular = TRUE) +
geom_edge_diagonal(
aes(color=node1.node.branch),
alpha=0.5)
p1+theme_minimal()
#添加边（edge），样式2；
p1 <- ggraph(graph,layout = 'dendrogram', circular = TRUE) +
geom_edge_link(aes(color=node1.node.branch),alpha=0.5)
p1 + theme_minimal()
#添加边（edge），样式3；
p1 <- ggraph(graph,layout = 'dendrogram', circular = TRUE) +
geom_edge_hive(aes(color=node1.node.branch),alpha=0.5)
p1+theme_minimal()
#添加边（edge），样式4；
p1 <- ggraph(graph,layout = 'dendrogram', circular = TRUE) +
geom_edge_arc(aes(color=node1.node.branch),alpha=0.5)
p1+theme_minimal()
#添加节点（node），将图形区域的颜色设置为白色；
#legend.position = "none"时隐藏图例；
p2 <- p1+geom_node_point(aes(size=node.size,color=node.branch),alpha=1/3)+
theme(panel.background = element_rect(fill = "white"),
legend.position = "none")
p2
p2 <- p1+geom_node_point(aes(size=node.size,color=node.branch),alpha=1/3)+
theme(panel.background = element_rect(fill = "black"),
legend.position = "none")
p2
p2 <- p1+geom_node_point(aes(size=node.size,color=node.branch), alpha=0.7)+
theme(panel.background = element_rect(fill = "white"),
legend.position = "none")
p2
p2 <- p1+geom_node_point(aes(size=node.size,color=node.branch), alpha=0.8)+
theme(panel.background = element_rect(fill = "white"),
legend.position = "none")
p2
p3 <- p2 + coord_fixed(clip = "off")
p3
p4 <- p3 + scale_size(range = c(0.5,30))
p4
p4 <- p3 + scale_size(range = c(5,20))
p4
p4 <- p3 + scale_size(range = c(3,20))
p4
p5 <- p4+geom_node_text(aes(x = 1.04 * x,y = 1.04 * y,
label = node.short_name,
angle = -((-node_angle(x, y) + 90) %% 180) + 90,
filter = leaf,
color = node.branch),
size = 1.5, hjust = 'outward')
p5
p5 <- p4+geom_node_text(aes(x = 1.04 * x,y = 1.04 * y,
label = node.short_name,
angle = -((-node_angle(x, y) + 90) %% 180) + 90,
filter = leaf,
color = node.branch),
size = 5, hjust = 'outward')
p5
p5 <- p4+geom_node_text(aes(x = 1.04 * x,y = 1.04 * y,
label = node.short_name,
angle = -((-node_angle(x, y) + 90) %% 180) + 90,
filter = leaf,
color = node.branch),
size = 3, hjust = 'outward')
p5
p5 <- p4+geom_node_text(aes(x = 1.04 * x,y = 1.04 * y,
label = node.short_name,
angle = -((-node_angle(x, y) + 90) %% 180) + 90,
filter = leaf,
color = node.branch),
size = 4, hjust = 'outward')
p5
p3 <- p2
p3
p4 <- p3 + scale_size(range = c(3,20))
p4
p5 <- p4+geom_node_text(aes(x = 1.04 * x,y = 1.04 * y,
label = node.short_name,
angle = -((-node_angle(x, y) + 90) %% 180) + 90,
filter = leaf,
color = node.branch),
size = 4, hjust = 'outward')
p5
p3 <- p2 + coord_fixed(clip = "off")
p3
p4 <- p3 +
scale_size(range = c(3,20)) +
coord_cartesian(xlim=c(-1.5,1.5),ylim = c(-1.5,1.5))
p4
p5 <- p4+geom_node_text(aes(x = 1.04 * x,y = 1.04 * y,
label = node.short_name,
angle = -((-node_angle(x, y) + 90) %% 180) + 90,
filter = leaf,
color = node.branch),
size = 4,
hjust = 'outward')
p5
p4 <- p3 +
scale_size(range = c(3,20)) +
coord_cartesian(xlim=c(-1,1),ylim = c(-1,1))
p4
p5 <- p4+geom_node_text(aes(x = 1.04 * x,y = 1.04 * y,
label = node.short_name,
angle = -((-node_angle(x, y) + 90) %% 180) + 90,
filter = leaf,
color = node.branch),
size = 4,
hjust = 'outward')
p5
p4 <- p3 +
scale_size(range = c(3,20)) +
coord_cartesian(xlim=c(-1.5,1.5),ylim = c(-1.5,1.5))
p4
p5 <- p4+geom_node_text(aes(x = 1.04 * x,y = 1.04 * y,
label = node.short_name,
angle = -((-node_angle(x, y) + 90) %% 180) + 90,
filter = leaf,
color = node.branch),
size = 4,
hjust = 'outward')
p5
p5 <- p4+geom_node_text(aes(x = 1.05 * x,y = 1.05 * y,
label = node.short_name,
angle = -((-node_angle(x, y) + 90) %% 180) + 90,
filter = leaf,
color = node.branch),
size = 4,
hjust = 'outward')
p5
p5 <- p4+geom_node_text(aes(x = 1.2 * x,y = 1.2 * y,
label = node.short_name,
angle = -((-node_angle(x, y) + 90) %% 180) + 90,
filter = leaf,
color = node.branch),
size = 4,
hjust = 'outward')
p5
p5 <- p4+geom_node_text(aes(x = 1.1 * x,y = 1.1 * y,
label = node.short_name,
angle = -((-node_angle(x, y) + 90) %% 180) + 90,
filter = leaf,
color = node.branch),
size = 4,
hjust = 'outward')
p5
p6 <- p5 + geom_node_text(
aes(label=node.short_name,color = node.branch),
fontface = "bold",
size = 3,
family = "sans",
data = filter(p5$data, node.level == "pathway"))
p6
mycolor <- c("#00a99e","#6bc72b","#ff5a20")
p7 <- p6 + scale_color_manual(values = rev(mycolor), guide = "none")
p7
mycolor <- c("#00a99e","#6bc72b","#ff5a20","#752995")
p7 <- p6 + scale_color_manual(values = rev(mycolor), guide = "none")
p7
p2 <- p1 +
geom_node_point(aes(size=node.size, color=node.branch), alpha=0.6) +
theme(panel.background = element_rect(fill = "white"),legend.position = "none")
p2
p3 <- p2 + coord_fixed(clip = "off")
p3
p4 <- p3 +
scale_size(range = c(3,20)) +
coord_cartesian(xlim=c(-1.5,1.5),ylim = c(-1.5,1.5))
p4
p5 <- p4+geom_node_text(aes(x = 1.1 * x,y = 1.1 * y,
label = node.short_name,
angle = -((-node_angle(x, y) + 90) %% 180) + 90,
filter = leaf,
color = node.branch),
size = 4,
hjust = 'outward')
p5
p6 <- p5 + geom_node_text(
aes(label=node.short_name,color = node.branch),
fontface = "bold",
size = 3,
family = "sans",
data = filter(p5$data, node.level == "pathway"))
p6
mycolor <- c("#00a99e","#6bc72b","#ff5a20","#752995")
p7 <- p6 + scale_color_manual(values = rev(mycolor), guide = "none")
p7
p6 <- p5 + geom_node_text(
aes(label=node.short_name,color = node.branch),
fontface = "bold",
size = 4,
family = "sans",
data = filter(p5$data, node.level == "pathway"))
p6
p6 <- p5 + geom_node_text(
aes(label=node.short_name,color = node.branch),
fontface = "bold",
size = 4.5,
family = "sans",
data = filter(p5$data, node.level == "pathway"))
p6
View(LumProg_Down_ORA_GO)
selected_pathways <- c("response to peptide hormone",
"mammary gland development",
"negative regulation of ERBB signaling pathway",
"ribosome localization",
"ribosome biogenesis")
to_plot <- LumProg_Down_ORA_GO %>%
filter(Description %in% selected_pathways) %>%
select(ID, Description, geneID, p.adjust) %>%
rename(pathway = Description, padj = p.adjust) %>%
mutate(gene = str_split(geneID, "/")) %>%
unnest(gene) %>%
select(pathway, gene, padj)
index <- c("pathway","gene")
nodes <- gather_graph_node(to_plot,index=index, root="root")
edges <- gather_graph_edge(to_plot,index=index, root="root")
graph <- tbl_graph(nodes = nodes,edges = edges)
p1 <- ggraph(graph, layout = 'dendrogram', circular = TRUE) +
geom_edge_diagonal(
aes(color=node1.node.branch),
alpha=0.5)
p1+theme_minimal()
p2 <- p1 +
geom_node_point(aes(size=node.size, color=node.branch), alpha=0.6) +
theme(panel.background = element_rect(fill = "white"),legend.position = "none")
p2
p3 <- p2 + coord_fixed(clip = "off")
p3
p4 <- p3 +
scale_size(range = c(3,20)) +
coord_cartesian(xlim=c(-1.5,1.5),ylim = c(-1.5,1.5))
p4
p5 <- p4+geom_node_text(aes(x = 1.1 * x,y = 1.1 * y,
label = node.short_name,
angle = -((-node_angle(x, y) + 90) %% 180) + 90,
filter = leaf,
color = node.branch),
size = 4,
hjust = 'outward')
p5
p6 <- p5 + geom_node_text(
aes(label=node.short_name,color = node.branch),
fontface = "bold",
size = 4.5,
family = "sans",
data = filter(p5$data, node.level == "pathway"))
p6
selected_pathways <- c("response to peptide hormone",
"mammary gland development",
"negative regulation of ERBB signaling pathway",
"ribosome localization",
"ribosome biogenesis",
"RNA splicing")
to_plot <- LumProg_Down_ORA_GO %>%
filter(Description %in% selected_pathways) %>%
select(ID, Description, geneID, p.adjust) %>%
rename(pathway = Description, padj = p.adjust) %>%
mutate(gene = str_split(geneID, "/")) %>%
unnest(gene) %>%
select(pathway, gene, padj)
index <- c("pathway","gene")
nodes <- gather_graph_node(to_plot,index=index, root="root")
edges <- gather_graph_edge(to_plot,index=index, root="root")
graph <- tbl_graph(nodes = nodes,edges = edges)
p1 <- ggraph(graph, layout = 'dendrogram', circular = TRUE) +
geom_edge_diagonal(
aes(color=node1.node.branch),
alpha=0.5)
p1+theme_minimal()
p2 <- p1 +
geom_node_point(aes(size=node.size, color=node.branch), alpha=0.6) +
theme(panel.background = element_rect(fill = "white"),legend.position = "none")
p2
p3 <- p2 + coord_fixed(clip = "off")
p3
p4 <- p3 +
scale_size(range = c(2, 15)) +
coord_cartesian(xlim=c(-1.5,1.5),ylim = c(-1.5,1.5))
p4
p5 <- p4+geom_node_text(aes(x = 1.1 * x,y = 1.1 * y,
label = node.short_name,
angle = -((-node_angle(x, y) + 90) %% 180) + 90,
filter = leaf,
color = node.branch),
size = 4,
hjust = 'outward')
p5
p6 <- p5 + geom_node_text(
aes(label=node.short_name,color = node.branch),
fontface = "bold",
size = 4.5,
family = "sans",
data = filter(p5$data, node.level == "pathway"))
p6
p5
p6 <- p5 + geom_node_text(
aes(label=node.short_name,color = node.branch),
fontface = "bold",
size = 5,
family = "sans",
data = filter(p5$data, node.level == "pathway"))
p6
library(tidyverse)
library(data.table)
library(viridis)
library(RColorBrewer)
# 1. Read in CellPhoneDB outputs (ND)
means <- fread("D:/data/23BMI/ND_HFD_MG_snRNAseq/cellphonedb/result/statistical_analysis_ND/statistical_analysis_means_06_22_2025_072909.txt")
setwd("/Users/coellearth/Desktop/Mammary_Gland_Diet_Project/4CellCellCommunication/01LIANA")
library(tidyverse)
library(magrittr)
library(liana)
require(tibble)
require(purrr)
library(e1071)
library(ggalluvial)
library(ggplot2)
library(MASS)
library(nortest)
library(dplyr)
show_resources()
show_methods()
ND_Seu <- readRDS("/Users/coellearth/Desktop/Mammary_Gland_Diet_Project/*originaldata/Harmony/harmony_ND.rds")
HFD_Seu <- readRDS("/Users/coellearth/Desktop/Mammary_Gland_Diet_Project/*originaldata/Harmony/harmony_HFD.rds")
###### 3. run LIANA ######
help("liana_wrap")
ND_lia <- liana_wrap(ND_Seu, idents_col = "cell_type", resource = "MouseConsensus")
ND_lia <- ND_lia %>%
liana_aggregate()
HFD_lia <- liana_wrap(HFD_Seu, idents_col = "cell_type", resource = "MouseConsensus")
HFD_lia <- HFD_lia %>%
liana_aggregate()
ND <- as.data.frame(ND_lia)
HFD <- as.data.frame(HFD_lia)
ND$CellCell <- paste0(ND$source, "_", ND$target)
HFD$CellCell <- paste0(HFD$source, "_", HFD$target)
View(ND)
ND <- ND %>%
arrange(aggregate_rank)
View(ND)
HFD <- HFD %>%
arrange(aggregate_rank)
ND <- ND %>%
arrange(aggregate_rank)
HFD <- HFD %>%
arrange(aggregate_rank)
write_csv(ND,
file = "/Users/coellearth/Desktop/Mammary_Gland_Diet_Project/4CellCellCommunication/01LIANA/ND_LIANA_res.csv")
write_csv(HFD,
file = "/Users/coellearth/Desktop/Mammary_Gland_Diet_Project/4CellCellCommunication/01LIANA/HFD_LIANA_res.csv")

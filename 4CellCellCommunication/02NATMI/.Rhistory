library(CellChat)
library(patchwork)
library(Seurat)
library(dplyr)
library(tidyverse)
options(stringsAsFactors = FALSE)
library(forcats)
setwd("/Users/coellearth/Desktop/Mammary_Gland_Diet_Project/4CellCellCommunication/02CellChat")
cellchat_HFD <- readRDS("/Users/coellearth/Desktop/Mammary_Gland_Diet_Project/4CellCellCommunication/02CellChat/CellChatObjects/cellchat_HFD")
comm_adipo_to_luminal_HFD <- subsetCommunication(cellchat_HFD, sources.use = "Basal", targets.use = "LumProg")
comm_adipo_to_luminal_HFD <- comm_adipo_to_luminal_HFD[order(comm_adipo_to_luminal_HFD$prob, decreasing=TRUE), ]
cellchat_ND <- readRDS("/Users/coellearth/Desktop/Mammary_Gland_Diet_Project/4CellCellCommunication/02CellChat/CellChatObjects/cellchat_ND")
comm_adipo_to_luminal_ND <- subsetCommunication(cellchat_ND, sources.use = "Basal", targets.use = "LumProg")
comm_adipo_to_luminal_ND <- comm_adipo_to_luminal_ND[order(comm_adipo_to_luminal_ND$prob, decreasing=TRUE), ]
## 一、准备数据：合并两个 comm 数据框
comm_HFD <- comm_adipo_to_luminal_HFD %>%
dplyr::select(interaction_name_2, ligand, receptor, prob, pathway_name, annotation) %>%
rename(prob_HFD = prob)
comm_ND <- comm_adipo_to_luminal_ND %>%
dplyr::select(interaction_name_2, ligand, receptor, prob, pathway_name, annotation) %>%
rename(prob_ND = prob)
comm_merged <- full_join(comm_HFD, comm_ND,
by = c("interaction_name_2", "ligand", "receptor")) %>%
mutate(prob_HFD = ifelse(is.na(prob_HFD), 0, prob_HFD),
prob_ND = ifelse(is.na(prob_ND), 0, prob_ND))
delta_cutoff <- quantile(abs(comm_merged$delta_prob), probs = 0.7, na.rm = TRUE)
comm_merged <- full_join(comm_HFD, comm_ND,
by = c("interaction_name_2", "ligand", "receptor")) %>%
mutate(prob_HFD = ifelse(is.na(prob_HFD), 0, prob_HFD),
prob_ND = ifelse(is.na(prob_ND), 0, prob_ND),
delta_prob = prob_HFD - prob_ND)
delta_cutoff <- quantile(abs(comm_merged$delta_prob), probs = 0.7, na.rm = TRUE)
comm_merged <- comm_merged %>%
mutate(
prob_ND = ifelse(prob_ND == 0, 1e-5, prob_ND),
prob_HFD = ifelse(prob_HFD == 0, 1e-5, prob_HFD),
fold_change = prob_HFD / prob_ND,
status = case_when(
delta_prob > delta_cutoff ~ "HFD_up",
delta_prob < -delta_cutoff ~ "HFD_down",
TRUE ~ "no_change"
),
status_fc = case_when(
fold_change > 2 ~ "HFD_up",
fold_change < 0.5 ~ "HFD_down",
TRUE ~ "no_change"
),
status_combined = case_when(
delta_prob > delta_cutoff & fold_change > 2 ~ "HFD_up",
delta_prob < -delta_cutoff & fold_change < 0.5 ~ "HFD_down",
TRUE ~ "no_change"
))
## 三、输出结果列表
comm_up <- comm_merged %>% filter(status_combined == "HFD_up") %>% arrange(desc(delta_prob))
comm_down <- comm_merged %>% filter(status_combined == "HFD_down") %>% arrange(delta_prob)
## 四、可视化
comm_plot <- comm_merged %>%
filter(status_combined != "no_change") %>%
mutate(interaction_name_2 = fct_reorder(interaction_name_2, abs(delta_prob))) %>%
pivot_longer(cols = c(prob_ND, prob_HFD),
names_to = "condition", values_to = "prob")
ggplot(comm_plot, aes(x = condition, y = interaction_name_2, size = prob, fill = condition)) +
geom_point(shape = 21, color = "black", alpha = 0.75) +
scale_size_continuous(range = c(1, 7), name = "CommProb") +
scale_fill_manual(values = c("prob_ND" = "#91b9e0", "prob_HFD" = "#f4a582"),
labels = c("ND", "HFD"), name = "Condition") +
facet_wrap(~ status_combined, scales = "free_y", ncol = 1,
labeller = as_labeller(c(HFD_up = "↑ HFD", HFD_down = "↓ HFD"))) +
labs(x = NULL, y = "L-R pair", title = "HFD vs ND Adipocyte → Luminal Progenitor") +
theme_bw(base_size = 8) +
theme(
axis.text.y = element_text(size = 10),
strip.text = element_text(size = 13, face = "bold"),
legend.position = "right"
)
## 四、可视化
comm_plot <- comm_merged %>%
filter(status_combined != "no_change") %>%
mutate(interaction_name_2 = fct_reorder(interaction_name_2, abs(delta_prob))) %>%
pivot_longer(cols = c(prob_ND, prob_HFD),
names_to = "condition", values_to = "prob")
ggplot(comm_plot, aes(x = condition, y = interaction_name_2, size = prob, fill = condition)) +
geom_point(shape = 21, color = "black", alpha = 0.75) +
scale_size_continuous(range = c(1, 7), name = "CommProb") +
scale_fill_manual(values = c("prob_ND" = "#91b9e0", "prob_HFD" = "#f4a582"),
labels = c("ND", "HFD"), name = "Condition") +
facet_wrap(~ status_combined, scales = "free_y", ncol = 1,
labeller = as_labeller(c(HFD_up = "↑ HFD", HFD_down = "↓ HFD"))) +
labs(x = NULL, y = "L-R pair", title = "HFD vs ND Basal → Luminal Progenitor") +
theme_bw(base_size = 8) +
theme(
axis.text.y = element_text(size = 10),
strip.text = element_text(size = 13, face = "bold"),
legend.position = "right"
)
cellchat_ND <- readRDS("/Users/coellearth/Desktop/Mammary_Gland_Diet_Project/4CellCellCommunication/02CellChat/CellChatObjects/cellchat_ND")
comm_adipo_to_luminal_ND <- subsetCommunication(cellchat_ND, sources.use = "Stroma", targets.use = "LumProg")
comm_adipo_to_luminal_ND <- comm_adipo_to_luminal_ND[order(comm_adipo_to_luminal_ND$prob, decreasing=TRUE), ]
cellchat_HFD <- readRDS("/Users/coellearth/Desktop/Mammary_Gland_Diet_Project/4CellCellCommunication/02CellChat/CellChatObjects/cellchat_HFD")
comm_adipo_to_luminal_HFD <- subsetCommunication(cellchat_HFD, sources.use = "Stroma", targets.use = "LumProg")
comm_adipo_to_luminal_HFD <- comm_adipo_to_luminal_HFD[order(comm_adipo_to_luminal_HFD$prob, decreasing=TRUE), ]
## 一、准备数据：合并两个 comm 数据框
comm_HFD <- comm_adipo_to_luminal_HFD %>%
dplyr::select(interaction_name_2, ligand, receptor, prob, pathway_name, annotation) %>%
rename(prob_HFD = prob)
comm_ND <- comm_adipo_to_luminal_ND %>%
dplyr::select(interaction_name_2, ligand, receptor, prob, pathway_name, annotation) %>%
rename(prob_ND = prob)
comm_merged <- full_join(comm_HFD, comm_ND,
by = c("interaction_name_2", "ligand", "receptor")) %>%
mutate(prob_HFD = ifelse(is.na(prob_HFD), 0, prob_HFD),
prob_ND = ifelse(is.na(prob_ND), 0, prob_ND),
delta_prob = prob_HFD - prob_ND)
delta_cutoff <- quantile(abs(comm_merged$delta_prob), probs = 0.7, na.rm = TRUE)
comm_merged <- comm_merged %>%
mutate(
prob_ND = ifelse(prob_ND == 0, 1e-5, prob_ND),
prob_HFD = ifelse(prob_HFD == 0, 1e-5, prob_HFD),
fold_change = prob_HFD / prob_ND,
status = case_when(
delta_prob > delta_cutoff ~ "HFD_up",
delta_prob < -delta_cutoff ~ "HFD_down",
TRUE ~ "no_change"
),
status_fc = case_when(
fold_change > 2 ~ "HFD_up",
fold_change < 0.5 ~ "HFD_down",
TRUE ~ "no_change"
),
status_combined = case_when(
delta_prob > delta_cutoff & fold_change > 2 ~ "HFD_up",
delta_prob < -delta_cutoff & fold_change < 0.5 ~ "HFD_down",
TRUE ~ "no_change"
))
## 三、输出结果列表
comm_up <- comm_merged %>% filter(status_combined == "HFD_up") %>% arrange(desc(delta_prob))
comm_down <- comm_merged %>% filter(status_combined == "HFD_down") %>% arrange(delta_prob)
## 四、可视化
comm_plot <- comm_merged %>%
filter(status_combined != "no_change") %>%
mutate(interaction_name_2 = fct_reorder(interaction_name_2, abs(delta_prob))) %>%
pivot_longer(cols = c(prob_ND, prob_HFD),
names_to = "condition", values_to = "prob")
ggplot(comm_plot, aes(x = condition, y = interaction_name_2, size = prob, fill = condition)) +
geom_point(shape = 21, color = "black", alpha = 0.75) +
scale_size_continuous(range = c(1, 7), name = "CommProb") +
scale_fill_manual(values = c("prob_ND" = "#91b9e0", "prob_HFD" = "#f4a582"),
labels = c("ND", "HFD"), name = "Condition") +
facet_wrap(~ status_combined, scales = "free_y", ncol = 1,
labeller = as_labeller(c(HFD_up = "↑ HFD", HFD_down = "↓ HFD"))) +
labs(x = NULL, y = "L-R pair", title = "HFD vs ND Basal → Luminal Progenitor") +
theme_bw(base_size = 8) +
theme(
axis.text.y = element_text(size = 10),
strip.text = element_text(size = 13, face = "bold"),
legend.position = "right"
)
## Bubble plot
netVisual_bubble(cellchat, sources.use = 1, targets.use = 4, remove.isolate = FALSE)
## Bubble plot
netVisual_bubble(cellchat_ND, sources.use = 1, targets.use = 4, remove.isolate = FALSE)
## Network plot
groupSize <- as.numeric(table(cellchat_ND@idents))
mat <- cellchat_ND@net$weight
par(mfrow = c(3,4), xpd=TRUE)
for (i in 1:nrow(mat)) {
mat2 <- matrix(0, nrow = nrow(mat), ncol = ncol(mat), dimnames = dimnames(mat))
mat2[i, ] <- mat[i, ]
netVisual_circle(mat2, vertex.weight = groupSize, weight.scale = T, edge.weight.max = max(mat), title.name = rownames(mat)[i])
}
netVisual_circle(cellchat_ND@net$count, vertex.weight = groupSize, weight.scale = T, label.edge= F, title.name = "Number of interactions")
netVisual_circle(cellchat_ND@net$count, vertex.weight = groupSize, weight.scale = T, label.edge= F, title.name = "Number of interactions")
netVisual_chord(cellchat_ND@net$count, vertex.weight = groupSize, weight.scale = T, label.edge= F, title.name = "Number of interactions")
netVisual_circle(cellchat_ND@net$count, vertex.weight = groupSize, weight.scale = T, label.edge= F, title.name = "Number of interactions")
netVisual_circle(cellchat_ND@net$weight, vertex.weight = groupSize, weight.scale = T, label.edge= F, title.name = "Interaction weights/strength")
netVisual_circle
library(tidyverse)
library(ggraph)
library(igraph)
library(ggplot2)
library(ggrepel)
library(clusterProfiler)
library(org.Mm.eg.db)
setwd("/Users/coellearth/Desktop/Mammary_Gland_Diet_Project/4CellCellCommunication/02NATMI")
# Down/Disappeared in HFD
down_in_HFD <- read.csv("/Users/coellearth/Desktop/Mammary_Gland_Diet_Project/4CellCellCommunication/02NATMI/Diff_HFD_vs_ND/Delta_edges_lrc2p/DOWN-regulated_mean.csv")
head(down_in_HFD)
down_in_HFD <- subset(down_in_HFD,
Sending.cluster == "Adipo"
&
Target.cluster == "LumProg")
down_in_HFD <- down_in_HFD %>%
mutate(z_expr = scale(Log2.transformed.fold.change.of.edge.expression.weight),
z_spec = scale(Log2.transformed.fold.change.of.edge.specificity.weight),
integrated_score = z_expr + z_spec) %>%
arrange(desc(integrated_score))
disa_in_HFD <- read.csv("/Users/coellearth/Desktop/Mammary_Gland_Diet_Project/4CellCellCommunication/02NATMI/Diff_HFD_vs_ND/Delta_edges_lrc2p/Disappeared_mean.csv")
head(disa_in_HFD)
disa_in_HFD <- subset(disa_in_HFD,
Sending.cluster == "Adipo"
&
Target.cluster == "LumProg")
# Up/Appeared in HFD
up_in_HFD <- read.csv("/Users/coellearth/Desktop/Mammary_Gland_Diet_Project/4CellCellCommunication/02NATMI/Diff_HFD_vs_ND/Delta_edges_lrc2p/UP-regulated_mean.csv")
head(up_in_HFD)
up_in_HFD <- subset(up_in_HFD,
Sending.cluster == "Adipo"
&
Target.cluster == "LumProg")
up_in_HFD <- up_in_HFD %>%
mutate(z_expr = scale(Log2.transformed.fold.change.of.edge.expression.weight),
z_spec = scale(Log2.transformed.fold.change.of.edge.specificity.weight),
integrated_score = z_expr + z_spec) %>%
arrange(desc(integrated_score))
a_in_HFD <- read.csv("/Users/coellearth/Desktop/Mammary_Gland_Diet_Project/4CellCellCommunication/02NATMI/Diff_HFD_vs_ND/Delta_edges_lrc2p/Appeared_mean.csv")
head(a_in_HFD)
a_in_HFD <- subset(a_in_HFD,
Sending.cluster == "Adipo"
&
Target.cluster == "LumProg")
###### Enrichment ######
setwd("/Users/coellearth/Desktop/Mammary_Gland_Diet_Project/4CellCellCommunication/02NATMI/Diff_HFD_vs_ND/Delta_edges_lrc2p")
down   <- read.csv("DOWN-regulated_mean.csv")   %>% mutate(category="Loss")
disap  <- read.csv("Disappeared_mean.csv")      %>% mutate(category="Loss")
up     <- read.csv("UP-regulated_mean.csv")     %>% mutate(category="Gain")
appe   <- read.csv("Appeared_mean.csv")         %>% mutate(category="Gain")
setwd("/Users/coellearth/Desktop/Mammary_Gland_Diet_Project/4CellCellCommunication/02NATMI")
edges_all <- bind_rows(down, disap, up, appe)
edges_adipo2lum <- edges_all %>%
filter(Sending.cluster=="Adipo", Target.cluster=="LumProg")
gain_ligands  <- unique(edges_all %>% filter(category=="Gain") %>% pull(Ligand.symbol))
loss_ligands  <- unique(edges_all %>% filter(category=="Loss") %>% pull(Ligand.symbol))
gain_receptors<- unique(edges_all %>% filter(category=="Gain") %>% pull(Receptor.symbol))
loss_receptors<- unique(edges_all %>% filter(category=="Loss") %>% pull(Receptor.symbol))
gain <- unique(c(gain_ligands, gain_receptors))
loss <- unique(c(loss_ligands, loss_receptors))
go_gain_res <- enrichGO(gain_ligands, OrgDb=org.Mm.eg.db, keyType="SYMBOL", ont="BP")
View(a_in_HFD)
View(disa_in_HFD)
View(down_in_HFD)
View(up_in_HFD)
